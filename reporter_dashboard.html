<!DOCTYPE html>
<html>
  <head>
      <title>My Issues</title>
      <link rel='stylesheet' type='text/css' href='assets/main.css'>
      <link rel='stylesheet' type='text/css' href='assets/semantic.min.css'>
      <script src='assets/jquery.min.js'></script>
      <script src='assets/semantic.min.js'></script>
      <script src='assets/main.js'></script>
      <script>
        $(function(){
          var user_id     = localStorage.getItem('user_id'),
              role        = localStorage.getItem('role');
          if (!user_id) {
            window.location.replace('index.html');
          }

          if (!role) {
            window.location.replace('index.html');
          } else if (role != 1) {
            $('#main').html(' You do not have permissions to view this page.');
            $('#loading').hide();
          } else {
            $.ajax({
              url: "http://ec2-54-237-22-83.compute-1.amazonaws.com/incident/user/" + user_id,
              success: function (data) {
                $("#incident-list-my").append('<div class="link item"><div id="add-new-incident" class="content new-building-button"><a class="header"><i class="huge add circle icon teal"></i>Create a New Incident</a></div>');
                $.each(data, function(key, incident){
                  if (!incident.image) {
                    incident.image = 'assets/image.png'
                  }
                  $("#incident-list-my").append('<div class="link item"> <div class="ui tiny image"> <img src="' + incident.image +'"> </div><div id=' + incident.incident_id + ' class="content view-building-button"><a class="header">' + incident.address + '</a><div class="meta"><b>Status:</b>' + incident.status + '<br><b>Reported:</b> ' + incident.date_reported +'</div><div class="description">' + incident.description + '</div></div>');
                });
                $('.view-building-button').click(function(e){
                  localStorage.setItem("building_id", e.target.id);
                  window.location.replace('reporter_dashboard.html');
                });
                $('.new-building-button').click(function(e){
                  window.location.replace('create_incident.html');
                });
              },
              error: function (data) {
                window.location.replace('error.html');
              }
            }).then(function(){
              $.ajax({
                url: "http://ec2-54-237-22-83.compute-1.amazonaws.com/incident/all/" + user_id,
                success: function (data) {
                  $("#incident-list-all").append('<div class="link item"><div id="add-new-incident" class="content new-building-button"><a class="header"><i class="huge add circle icon teal"></i>Create a New Incident</a></div>');
                  $.each(data, function(key, incident){
                    if (!incident.image) {
                      incident.image = 'assets/image.png'
                    }
                    $("#incident-list-all").append('<div class="link item"> <div class="ui tiny image"> <img src="' + incident.image +'"> </div><div id=' + incident.incident_id + ' class="content view-building-button"><a class="header">' + incident.address + '</a><div class="meta"><b>Status:</b>' + incident.status + '<br><b>Reported:</b> ' + incident.date_reported +'</div><div class="description">' + incident.description + '</div></div>');
                  });
                  $('.view-building-button').click(function(e){
                    localStorage.setItem("building_id", e.target.id);
                    window.location.replace('reporter_dashboard.html');
                  });
                  $('.new-building-button').click(function(e){
                    window.location.replace('create_incident.html');
                  });
                  $('#loading').hide();
                },
                error: function (data) {
                  window.location.replace('error.html');
                }
              });
            });
            $('.item').click(function(){
              $('.active').removeClass('active');
              $(this).addClass('active');
              if (this.text.trim() == 'All Issues') {
                $('#incident-list-my').addClass('hidden');
                $('#incident-list-all').removeClass('hidden');
                $('#map-view').addClass('hidden');
              } else if(this.text.trim() == 'My Issues') {
                $('#incident-list-all').addClass('hidden');
                $('#incident-list-my').removeClass('hidden');
                $('#map-view').addClass('hidden');
              } else if(this.text.trim() == 'Summary') {
                $('#incident-list-all').addClass('hidden');
                $('#incident-list-my').addClass('hidden');
                $('#map-view').removeClass('hidden');
              }
            });
            $('.ui.dropdown').dropdown();
            $.ajax({
              url: "http://ec2-54-237-22-83.compute-1.amazonaws.com/buildings/user/" + user_id,
              success: function (data) {
                $.each(data, function(key, building){
                  $('#building-dropdown').append("<div class='item' data-value='" + building.building_id + "'>" + building.address + "</div>");
                });
              },
              error: function (data) {
              }
            });
          }
        });
      </script>
  </head>
  <body bgcolor='#242624'>
    <div class="ui top sidebar ui segment">
      <div class="ui center aligned page grid">
        <div class="one column row">
          <div class="sixteen wide column">
            <h3 id="logout" class="ui header">Logout</h3>
          </div>
        </div>
      </div>
    </div>
    <div class='ui piled segment'>
      <div class='ui teal dividing header'>
        <i class='configure icon left'></i>
        <div class='content left'>
          Fix It Now!
          <div class='sub header'>Crowd Sourced Facility Management</div>
        </div>
        <i class='sidebar icon right'></i>
      </div>
    </div>
    <div id="loading">
      <div class="ui active dimmer">
        <div class="ui indeterminate text active loader">
          Loading...
        </div>
      </div>
    </div>
    <div id='main'>
      <div class="ui top attached tabular menu">
        <a class="active item">
          My Issues
        </a>
        <a class="item">
          All Issues
        </a>
        <a class="item">
          Summary
        </a>
      </div>
      <div class='ui stacked segment welcome'>
        <div id="incident-list-my" class='ui divided items'>
        </div>
        <div id="incident-list-all" class='ui divided items hidden'>
        </div>
        <div id="map-view" class='ui form segment hidden'>
          <div class='field'>
            <label>Building</label>
            <div class="ui selection dropdown" id='building-select' tabindex="0">
              <div class="default text">Select</div>
              <i class="dropdown icon"></i>
              <input name="hidden-field" type="hidden" id='selected-building-id'>
              <div class="menu transition hidden" id='building-dropdown' tabindex="-1" style="">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>